---
title: "Bachelorarbeit"
author: "Laura Kiemes, 12250912"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

# Setup

```{r setup}
if (!require("pacman")) install.packages("pacman"); library(pacman)
pacman::p_load(devtools)
#if (!require("stdidx")) devtools::install_github("graemeblair/stdidx"); library(stdidx)
#if (!require("summarytools")) install.packages("summarytools"); library(summarytools)
pacman::p_load(haven, readr, tidyverse, gtsummary, ggsci, ROSE, labelled, matrixStats, car, psych, lsr, modelsummary, olsrr, moments, estimatr)

here::i_am("code.Rmd")

theme_set(theme_minimal())

set.seed(12250912)

colours_colourblind <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
names(colours_colourblind) <- c("blindblack", "blindorange", "blindlightblue", "blindgreen", "blindyellow", "blindblue", "blinddarkorange", "blindpurple")

dpi <- c(700) # for ggsave
```

# Datenbereinigung

## Datenimport

```{r}
allbus2006 <- read_dta(here::here("data", "ZA4500_v2-0-0.dta")) # gesis data
```

## Oversampling aufheben

```{r re-oversampling}
allbus2006 |> 
  summarise(n = n())

allbus2006 |> 
  group_by(v4) |> 
  summarise(n = n())

west <- allbus2006 |> filter(v4 == 1)
east <- allbus2006 |> filter(v4 == 2)

1122 * 0.562993624 # Anzahl Ost-Befragte im Zielsample
weighted_east <- east[sample(nrow(east), size = 1122 * 0.562993624), ] # Zielsample Ost

allbus2006 <- rbind(west, weighted_east) # Zielsample gesamt

allbus2006 |> 
  group_by(v4) |> 
  summarise(n = n())
```

## Variablen

### Immigration

```{r immigration}
# Skala: 
#0 Keine deutsche Staatsbürgerschaft (Code 2-24 in F010_1)
#1 Stimme überhaupt nicht zu
#2 ..
#3 ..
#4 ..
#5 ..
#6 ..
#7 Stimme voll und ganz zu
#99 Keine Angabe

#Fragen
#V43: Die in Deutschland lebenden Ausländer sollten ihren Lebensstil ein bisschen besser an den der Deutschen anpassen.
#V44: Wenn Arbeitsplätze knapp werden, sollte man die in Deutschland lebenden Ausländer wieder in ihre Heimat zurückschicken.
#V45: Man sollte den in Deutschland lebenden Ausländern jede politische Betätigung in Deutschland untersagen.
#V46: Die in Deutschland lebenden Ausländer sollten sich ihre Ehepartner unter ihren eigenen Landsleuten auswählen.

allbus2006 <- allbus2006 |> 
  mutate(
    immigration_anpassen = case_when(v43 %in% c(1:7) ~ v43 * (-1) + 8,
                                     TRUE ~ NA),
    immigration_heim = case_when(v44 %in% c(1:7) ~ v44 * (-1) + 8,
                                 TRUE ~ NA),
    immigration_unpolit = case_when(v45 %in% c(1:7) ~ v45 * (-1) + 8,
                                    TRUE ~ NA),
    immigration_heirat = case_when(v46 %in% c(1:7) ~ v46 * (-1) + 8,
                                   TRUE ~ NA)
  ) 

### Cronbachs alpha 

alpha_immigration <- allbus2006 |> 
  select(immigration_anpassen, immigration_heim, immigration_unpolit, immigration_heirat) |> 
  alpha(check.keys = TRUE)

alpha_immigration

alpha_immigration[["total"]]$raw_alpha |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "alpha_immigration.txt"), sep = "", col.names = FALSE, row.names = FALSE)

alpha_immigration[["alpha.drop"]]$raw_alpha |> 
  max() |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "alpha_drop_immigration.txt"), sep = "", col.names = FALSE, row.names = FALSE)



### Index

allbus2006$immigration <- rowMeans(allbus2006[,c("immigration_anpassen", "immigration_heim", "immigration_unpolit", "immigration_heirat")], na.rm = TRUE)

### Test

allbus2006 |> 
  group_by(v43, immigration_anpassen) |> 
  summarise(n())

allbus2006 |> 
  group_by(v44, immigration_heim) |> 
  summarise(n())

allbus2006 |> 
  group_by(v45, immigration_unpolit) |> 
  summarise(n())

allbus2006 |> 
  group_by(v46, immigration_heirat) |> 
  summarise(n())

allbus2006 |>
  select(immigration) |> 
  summary()

allbus2006 |> 
  select(immigration_anpassen, 
         immigration_heim, 
         immigration_unpolit, 
         immigration_heirat,
         immigration)
```

### Soziale Erwünschtheit

#### Split & Split-Erfolg

```{r split}
allbus2006 <- allbus2006 |> 
  mutate(
    split = case_when(v3 == 2 ~ 0,
                      TRUE ~ v3), # split binaer
    split = factor(split,
                        levels = c(0, 1),
                        labels = c("CASI",
                                   "CAPI")),
    split_erfolg = factor(v47,
                          levels = c(0:4),
                          labels = c("CAPI", 
                                     "ja, ohne Hilfe",
                                     "ja, Hilfe vorher",
                                     "ja, Hilfe dabei",
                                     "nein")) # split casi erfolg
  )

allbus2006 |> 
  group_by(v3, split) |> 
  summarise(n())
```

#### SD-Neigung

```{r sdtendency}
# Skala
#1 Richtig
#2 Falsch
#9 Keine Angabe

# Fragen
#V54: Vor einer Wahl informiere ich mich gründlich über die Eignung der verschiedenen Kandidaten. (+)
#V55: Manchmal bin ich beleidigt, wenn es nicht nach meinem Willen geht. (-)
#V56: Ich bin stets ein guter Zuhörer, gleichgültig, wer mein Gesprächspartner ist. (+)
#V57: Ich kann mich daran erinnern, dass ich schon einmal krank gespielt habe, um eine Pflicht zu umgehen. (-)
#V58: Bei Gelegenheit habe ich schon einmal jemanden ausgenutzt. (-)
#V59: Wenn ich einen Fehler gemacht habe, bin ich stets bereit, das zuzugeben. (+)
#V60: Ich halte mich immer selber an Grundsätze, deren Befolgung ich von anderen erwarte. (+)
#V61: Ich bin stets höflich, selbst zu Leuten, die ich abstoßend finde. (+)
#V62: Manchmal bin ich ärgerlich auf Leute, die mich um einen Gefallen bitten. (-)
#V63: Ich habe noch nie absichtlich etwas gesagt, um die Gefühle anderer zu verletzen. (+)

allbus2006 <- allbus2006 |> 
  mutate(
    sdtendency_wahl = case_when(v54 == 2 ~ 0,
                     v54 == 1 ~ v54,
                     TRUE ~ NA),
    sdtendency_niebeleidigt = v55 - 1,
    sdtendency_niebeleidigt = case_when(sdtendency_niebeleidigt %in% c(0, 1) ~ sdtendency_niebeleidigt,
                                        TRUE ~ NA),
    sdtendency_ohr = case_when(v56 == 2 ~ 0,
                               v56 == 1 ~ v56,
                               TRUE ~ NA),
    sdtendency_niekrank = v57 - 1,
    sdtendency_niekrank = case_when(sdtendency_niekrank %in% c(0, 1) ~ sdtendency_niekrank,
                                    TRUE ~ NA),
    sdtendency_nieausnutzen = v58 - 1,
    sdtendency_nieausnutzen = case_when(sdtendency_nieausnutzen %in% c(0, 1) ~ sdtendency_nieausnutzen,
                                        TRUE ~ NA),
    sdtendency_zugeben = case_when(v59 == 2 ~ 0,
                                   v59 == 1 ~ v59,
                                   TRUE ~ NA),
    sdtendency_selber = case_when(v60 == 2 ~ 0,
                                  v60 == 1 ~ v60,
                                  TRUE ~ NA),
    sdtendency_hoeflich = case_when(v61 == 2 ~ 0,
                                    v61 == 1 ~ v61,
                                    TRUE ~ NA),
    sdtendency_nieaerger = v62 - 1,
    sdtendency_nieaerger = case_when(sdtendency_nieaerger %in% c(0, 1) ~ sdtendency_nieaerger,
                                     TRUE ~ NA),
    sdtendency_nieverletzt = case_when(v63 == 2 ~ 0,
                                       v63 == 1 ~ v63,
                                       TRUE ~ NA)
  )

### Cronbachs alpha

alpha_sdtendency <- allbus2006 |> 
  select(sdtendency_wahl, sdtendency_niebeleidigt, sdtendency_ohr, 
         sdtendency_niekrank, sdtendency_nieausnutzen, sdtendency_zugeben, 
         sdtendency_selber, sdtendency_hoeflich, sdtendency_nieaerger, 
         sdtendency_nieverletzt) |> 
  alpha(check.keys = TRUE) 

alpha_sdtendency

alpha_sdtendency[["total"]]$raw_alpha |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "alpha_sdtendency.txt"), sep = "", col.names = FALSE, row.names = FALSE)

alpha_sdtendency[["alpha.drop"]]$raw_alpha |> 
  max() |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "alpha_drop_sdtendency.txt"), sep = "", col.names = FALSE, row.names = FALSE)


### Test

allbus2006 |> 
  group_by(v54, sdtendency_wahl) |> 
  summarise(n())

allbus2006 |> 
  group_by(v55, sdtendency_niebeleidigt) |> 
  summarise(n())

allbus2006 |> 
  group_by(v56, sdtendency_ohr) |> 
  summarise(n())

allbus2006 |> 
  group_by(v57, sdtendency_niekrank) |> 
  summarise(n())

allbus2006 |> 
  group_by(v58, sdtendency_nieausnutzen) |> 
  summarise(n())

allbus2006 |> 
  group_by(v59, sdtendency_zugeben) |> 
  summarise(n())

allbus2006 |> 
  group_by(v60, sdtendency_selber) |> 
  summarise(n())

allbus2006 |> 
  group_by(v61, sdtendency_hoeflich) |> 
  summarise(n())

allbus2006 |> 
  group_by(v62, sdtendency_nieaerger) |> 
  summarise(n())

allbus2006 |> 
  group_by(v63, sdtendency_nieverletzt) |> 
  summarise(n())

# Index

allbus2006$sdtendency <- rowMeans(allbus2006[,c("sdtendency_wahl", 
                                                "sdtendency_niebeleidigt", 
                                                "sdtendency_ohr", 
                                                "sdtendency_niekrank", 
                                                "sdtendency_nieausnutzen", 
                                                "sdtendency_zugeben", 
                                                "sdtendency_selber", 
                                                "sdtendency_hoeflich", 
                                                "sdtendency_nieaerger", 
                                                "sdtendency_nieverletzt")], na.rm = TRUE)

# Test 

allbus2006 |>
  select(sdtendency) |> 
  summary()

allbus2006 |> 
  select(sdtendency_wahl, sdtendency_niebeleidigt, sdtendency_ohr, 
         sdtendency_niekrank, sdtendency_nieausnutzen, sdtendency_zugeben, 
         sdtendency_selber, sdtendency_hoeflich, sdtendency_nieaerger, 
         sdtendency_nieverletzt, sdtendency)
```

#### SD-Wahrnehmung

```{r sdperception}
# Skala
# 1 -3 Sehr negativ bewertet
# 2 -2
# 3 -1
# 4  0
# 5 +1
# 6 +2
# 7 +3 Sehr positiv bewertet
# 99 Keine Angabe

# Frage
# V84: Die in Deutschland lebenden Ausländer sollten ihren Lebensstil ein bisschen besser an den der Deutschen anpassen. (-)
# V85: Die in Deutschland lebenden Ausländer sollten ihren Lebensstil beibehalten dürfen, auch wenn er sich vom Lebensstil der Deutschen unterscheidet. (+)
# V86: Wenn Arbeitsplätze knapp werden, sollte man die in Deutschland lebenden Ausländer wieder in Ihre Heimat zurückschicken. (-)
# V87: Auch wenn Arbeitsplätze knapp werden, sollten die in Deutschland lebenden Ausländer hier bleiben dürfen. (+)
# V88: Man sollte den in Deutschland lebenden Ausländern jede politische Betätigung in Deutschland untersagen.  (-)
# V89: Die in Deutschland lebenden Ausländer sollten sich in Deutschland politisch betätigen dürfen.  (+)
# V90: Die in Deutschland lebenden Ausländer sollten sich ihre Ehepartner unter ihren eigenen Landsleuten auswählen.  (-)
# V91: Die in Deutschland lebenden Ausländer sollten sich ihre Ehepartner auch außerhalb ihrer eigenen Landsleute auswählen dürfen. (+)

allbus2006 <- allbus2006 |> 
  mutate(
    bewertung_nielebensstil = case_when(v84 == 99 ~ NA, TRUE ~ v84),
    bewertung_lebensstil = case_when(v85 == 99 ~ NA, TRUE ~ v85),
    lebensstil = abs(bewertung_nielebensstil - bewertung_lebensstil), #diff
    
    bewertung_niearbeit = case_when(v86 == 99 ~ NA, TRUE ~ v86),
    bewertung_arbeit = case_when(v87 == 99 ~ NA, TRUE ~ v87),
    arbeitsplatz = abs(bewertung_niearbeit - bewertung_arbeit), #diff
    
    bewertung_niepolitik = case_when(v88 == 99 ~ NA, TRUE ~ v88),
    bewertung_politik = case_when(v89 == 99 ~ NA, TRUE ~ v89),
    politik = abs(bewertung_niepolitik - bewertung_politik), #diff
    
    bewertung_nieehe = case_when(v90 == 99 ~ NA, TRUE ~ v90),
    bewertung_ehe = case_when(v91 == 99 ~ NA, TRUE ~ v91),
    ehepartner = abs(bewertung_nieehe - bewertung_ehe) #diff
  ) 

# Test

allbus2006 |> 
  select(v84, bewertung_nielebensstil, v85, bewertung_lebensstil, lebensstil)


allbus2006 |> 
  group_by(v84, bewertung_nielebensstil) |> 
  summarise(n())

allbus2006 |> 
  group_by(v85, bewertung_lebensstil) |> 
  summarise(n())

allbus2006 |> 
  group_by(v86, bewertung_niearbeit) |> 
  summarise(n())

allbus2006 |> 
  group_by(v87, bewertung_arbeit) |> 
  summarise(n())

allbus2006 |> 
  group_by(v88, bewertung_niepolitik) |> 
  summarise(n())

allbus2006 |> 
  group_by(v89, bewertung_politik) |> 
  summarise(n())

allbus2006 |> 
  group_by(v90, bewertung_nieehe) |> 
  summarise(n())

allbus2006 |> 
  group_by(v91, bewertung_ehe) |> 
  summarise(n())



### Cronbachs alpha

alpha_sdperception <- allbus2006 |> 
  select(lebensstil, arbeitsplatz, politik, ehepartner) |> 
  alpha(check.keys = TRUE) 

alpha_sdperception

alpha_sdperception[["total"]]$raw_alpha |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "alpha_sdperception.txt"), sep = "", col.names = FALSE, row.names = FALSE)

alpha_sdperception[["alpha.drop"]]$raw_alpha |> 
  max() |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "alpha_drop_sdperception.txt"), sep = "", col.names = FALSE, row.names = FALSE)

# Index

allbus2006$sdperception <- rowMeans(allbus2006[,c("lebensstil", 
                                                  "arbeitsplatz", 
                                                  "politik", 
                                                  "ehepartner")], na.rm = TRUE)

# Index standardisieren 

allbus2006 |> 
  select(sdperception) |> 
  summary()

allbus2006 <- allbus2006 |> 
  mutate(sdperception = (sdperception - min(sdperception, na.rm = TRUE)) / 
           (max(sdperception, na.rm = TRUE) - min(sdperception, na.rm = TRUE)))



summary(allbus2006$sdperception)

# missings untersuchen
allbus2006 |> 
  filter(v43 != 0, is.na(sdperception)) |> 
  select(bewertung_nielebensstil, bewertung_lebensstil, bewertung_niearbeit, 
         bewertung_arbeit, bewertung_niepolitik, bewertung_politik, 
         bewertung_nieehe, bewertung_ehe)
```


### Interviewereffekte

#### Geschlecht

```{r interviewer sex}
# Skala
# v702
# 1 Männlich 
# 2 Weiblich


allbus2006 <- allbus2006 |> 
  mutate(
    int_sex = case_when(v702 == 2 ~ 0, 
                                 TRUE ~ v702), # geschlecht interviewer/-in
    int_sex = factor(int_sex,
                             levels = c(0, 1),
                             labels = c("Weiblich", "Männlich"))
  )

allbus2006 |> 
  group_by(v702, int_sex) |> 
  summarise(n())
```

#### Alter & Altersdifferenz

```{r interviewer age cen & agediff}
### v703 Alter

allbus2006 <- allbus2006 |> 
  mutate(
    int_age = v703, # keine NA
    int_agecen = int_age - mean(int_age, na.rm = TRUE),
    int_agediff = case_when(v703 == 999 ~ NA, 
                                    v27 == 999 ~ NA,
                                    TRUE ~ abs(v703 - v27)),
    int_edu = case_when(v705 == 1 | v705 == 2 ~ 0,
                        v705 == 3 | v705 == 4 ~ 1,
                        TRUE ~NA)
  )


summary(allbus2006$int_age)
summary(allbus2006$int_agecen)
summary(allbus2006$int_agediff)

allbus2006 |> 
  select(v27, int_agediff, int_age, int_agecen)


```

#### Bildung

```{r interviewer edu}
#  Skala
# 1 Volks- / Hauptschulabschluss bzw. Polytechnische Oberschule mit Abschluss 8. oder 9. Klasse
# 2 Mittlere Reife, Realschulabschluss bzw. Polytechnische Oberschule mit Abschluss 10. Klasse
# 3 Fachhochschulreife, Abitur (Hochschulreife) bzw. Erweiterte Oberschule mit Abschluss 12. Klasse
# 4 Fachhochschul-/ Hochschulabschluss

allbus2006 <- allbus2006 |> 
  mutate(
    int_edu = case_when(v705 %in% c(1, 2) ~ 0,
                                v705 %in% c(3, 4) ~ 1,
                                TRUE ~ NA),
    int_edu = factor(int_edu,
                             levels = c(0, 1), 
                             labels = c("ohne Abitur",
                                        "Abitur"))
    )

allbus2006 |> 
  group_by(v705, int_edu) |> 
  summarise(n())

allbus2006 |> 
  select(v705, int_edu)
```

#### Erfahrung

```{r interviewer exp}
### v706
#0 Noch kein ganzes Jahr

allbus2006 <- allbus2006 |> 
  mutate(
    int_exp = as.numeric(v706)
  )

allbus2006 |> 
  select(v706, int_exp)
```



### Personeneffekte

#### Alter & Alter zentriert

```{r interviewee age & age cen}
# Skala
# 999 Keine Angabe

allbus2006 <- allbus2006 |> 
  mutate(
    
    age = as.numeric(case_when(v27 == 999 ~ NA,
                      TRUE ~ v27)),
    age_cen = age - mean(age, na.rm = TRUE)
  )

summary(allbus2006$age)
summary(allbus2006$age_cen)

allbus2006 |> 
  select(v27, age, age_cen)
```


#### Geschlecht

```{r interviewee sex}
# Skala
# 1 Männlich 
# 2 Weiblich

allbus2006 <- allbus2006 |> 
  mutate(
    sex = v174 - 1,
    sex = factor(sex,
                 levels = c(0, 1),
                 labels = c("Männlich", "Weiblich")), # geschlecht befragte person
    int_sexdiff = abs(v702 - v174)
  )

allbus2006 |> 
  group_by(v174, sex, int_sex, int_sexdiff) |> 
  summarise(n())

allbus2006 |> 
  group_by(sex, int_sex, int_sexdiff) |> 
  summarise(n())
```


#### Bildung

```{r}
# Skala
# 1 B Schule beendet ohne Abschluss
# 2 C Volks- / Hauptschulabschluss bzw. Polytechnische Oberschule mit Abschluss 8. oder 9. Klasse
# 3 D Mittlere Reife, Realschulabschluss bzw. Polytechnische Oberschule mit Abschluss 10. Klasse
# 4 E Fachhochschulreife (Abschluss einer Fachoberschule etc.)
# 5 F Abitur bzw. Erweiterte Oberschule mit Abschluss 12. Klasse (Hochschulreife)
# 6 G Anderen Schulabschluss, und zwar: _______
# 7 A Noch Schüler
# 99 Keine Angabe

allbus2006 <- allbus2006 |> 
  mutate(
    edu = case_when(v175 %in% c(1:3) ~ 0, # ohne Abschluss/Volks-, Hauptschulabschluss/Mittlere Reife
                    v175 %in% c(4, 5) ~ 1, # Fachhochschulreife/Hochschulreife
                    TRUE ~ NA), # bildung befragte person
    edu = factor(edu,
                 levels = c(0, 1),
                 labels = c("ohne Abitur", "Abitur"))
  )

allbus2006 |> 
  group_by(v175, edu) |> 
  summarise(n())
```


## Variablenkonstruktion

```{r Variablenkonstruktion}
variablenkonstruktion <- data.frame(
  "Bezeichnung" = colnames(allbus2006 |> select(
    immigration,
    split,
    split_erfolg,
    sdtendency,
    sdperception,
    int_sex,
    int_agediff,
    int_edu,
    int_exp,
    age,
    sex,
    edu)),
  "Verwendet" = c("v43 - v46",
                  "v3",
                  "v47",
                  "v54 - v63",
                  "v84 - v91",
                  "v702",
                  "v27; v703",
                  "v705",
                  "v706",
                  "v27",
                  "v174",
                  "v175"),
  "Typ" = c("Index", 
            "Dummy",
            "Kategorial",
            "Index",
            "Index",
            "Dummy",
            "Metrisch",
            "Dummy",
            "Metrisch",
            "Metrisch",
            "Dummy",
            "Dummy")
)

variablenkonstruktion

variablenkonstruktion |> 
  write_csv(here::here("tables", "variablenkonstruktion.csv"))
```


```{r labels}
allbus2006 <- allbus2006 |> 
  set_variable_labels(
    immigration = "Einstellungen gegenüber Immigration",
    split = "Split Befragungsmodus",
    split_erfolg = "Erfolg des Splits",
    sdtendency = "Tendenz zu sozialer Erwünschtheit",
    sdperception = "Bewertung der Erwünschtheit",
    int_sexdiff = "Anderes Geschlecht Interviewer/-in und Interviewee",
    int_sex = "Geschlecht des/der Interviewers/-in",
    int_age = "Alter der/des Interviewer/-in",
    int_agecen = "Zentriertes Alter der/des Interviewer/-in",
    int_agediff = "Altersdifferenz Interviewer/-in Befragte/-r",
    int_edu = "Bildung des/der Interviewer/-in",
    int_exp = "Erfahrung des/der Interviewer/-in",
    age = "Alter",
    age_cen = "Zentriertes Alter",
    sex = "Geschlecht",
    edu = "Bildung"
  )
```


```{r masszahlen}
masszahlen <- allbus2006 |> 
  select(
    immigration,
    split,
    split_erfolg,
    sdtendency,
    sdperception,
    int_sex,
    int_sexdiff,
    int_age,
    int_agecen,
    int_agediff,
    int_edu,
    int_exp,
    age,
    age_cen,
    sex,
    edu
  ) |> 
  drop_na() |> 
  gtsummary::tbl_summary() |> 
  modify_header(label = "Maßzahlen ALLBUS 2006, ohne Ost-Oversample")

masszahlen

masszahlen |> 
  gtsummary::as_tibble() |> 
  print() |> 
  write_csv(here::here("tables", "masszahlen.csv"))
```

## Stichprobenkonstruktion

```{r stipro}
allbus2006 <- allbus2006 |> 
  mutate(sample = case_when(
    v43 == 0 ~ 0,
    is.na(immigration) ~ 1,
    is.na(sdtendency) ~ 2,
    is.na(sdperception) ~ 4,
    is.na(int_sex) ~ 5,
    is.na(int_age) ~ 6,
    is.na(int_edu) ~ 7,
    is.na(age) ~ 8,
    is.na(sex) ~ 9,
    is.na(edu) ~ 10,
    TRUE ~ 11,
    )
  )

 
allbus2006 |> 
  mutate(sample = factor(sample)) |> 
  select(sample) |> 
  set_variable_labels(sample = "Ausschlusskriterien") |> 
  tbl_summary() |> 
  modify_header(label = "ALLBUS 2006, ohne Ost-Oversample")


stipro <- allbus2006 |> 
  mutate(
    sample = as.numeric(sample),
    sample = factor(sample, labels = c(
    "Keine deutsche Staatsbürgerschaft",
    "Index zu Einstellungen gegenüber Immigration missing",
    "Index zu Tendenz zu sozialer Erwünschtheit missing",
    "Index zu Wahrnehmung zur Erwünschtheit missing",
    "Alter missing",
    "Bildung missing",
    "Analysesample"))
  ) |> 
  select(sample) |> 
  set_variable_labels(sample = "Ausschlusskriterien") |> 
  tbl_summary() |> 
  modify_header(label = "ALLBUS 2006, ohne Ost-Oversample")

stipro

stipro |> 
  gtsummary::as_tibble() |> 
  write_csv(here::here("tables", "stichprobenkonstruktion.csv"))
```

```{r stipro missing immigration}
allbus2006 |> 
  filter(v43 != 0) |> # deutsche Staatsbürgerschaft
  filter(is.na(immigration)) |> # Missing für alle 4 Fragen zu Immigration
  select(split) # Split
```


## Datenexport

```{r analysesample}
allbus2006 <- allbus2006 |> 
  select(
    immigration,
    split,
    split_erfolg,
    sdtendency,
    sdperception,
    int_sex,
    int_sexdiff,
    int_age,
    int_agecen,
    int_agediff,
    int_edu,
    int_exp,
    age,
    age_cen,
    sex,
    edu
  ) |> 
  drop_na()
```


```{r save csv}
write_csv(allbus2006, here::here("data", "allbus2006.csv")) # save as csv
```


# Analyse

## Univariate Deskription

```{r}
allbus2006 |> 
  tbl_summary()

allbus2006  |> 
  tbl_summary()  |> 
  gtsummary::as_tibble() |> 
  write_csv(here::here("tables", "summary.csv"))

stats <- allbus2006 |> 
  select(immigration) |> 
  summarise(min = min(immigration),
            max = max(immigration),
            median = median(immigration),
            mean = mean(immigration),
            sd = sd(immigration),
            iqr = iqr(immigration),
            skew = skew(immigration),
            kurtosis = kurtosis(immigration),
            quantilest = quantile(immigration, probs = c(0.25)),
            quantilerd = quantile(immigration, probs = c(0.75)))

stats

# median 

stats[[1, "median"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "median.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# mean

stats[[1, "mean"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "mean.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# sd

stats[[1, "sd"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "sd.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# iqr

stats[[1, "iqr"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "iqr.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# skew

stats[[1, "skew"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "skew.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# kurtosis

stats[[1, "kurtosis"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "kurtosis.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# 1st quartile

stats[[1, "quantilest"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "quartile_first.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# 3rd quartile

stats[[1, "quantilerd"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "quartile_third.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)
```



## Zentraler Zusammenhang

```{r zentraler zusammenhang}
allbus2006  |> 
  select(immigration, split) |> 
  tbl_summary(by = split)  |> 
  add_p()

tbl_zusammenhang <- allbus2006  |> 
  select(immigration, split) |> 
  tbl_summary(by = split)  |> 
  add_p() |> 
  gtsummary::as_tibble() |> 
  write_csv(here::here("tables", "vergleich.csv"))

stats_split <- allbus2006 |> 
  group_by(split) |> 
  select(immigration) |> 
  summarise(median = median(immigration),
            mean = mean(immigration),
            sd = sd(immigration),
            iqr = iqr(immigration),
            skew = skew(immigration),
            kurtosis = kurtosis(immigration),
            quantilest = quantile(immigration, probs = c(0.25)),
            quantilerd = quantile(immigration, probs = c(0.75)))

stats_split

# median 

stats_split[[1, "median"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "median_casi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

stats_split[[2, "median"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "median_capi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# mean

stats_split[[1, "mean"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "mean_casi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

stats_split[[2, "mean"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "mean_capi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# sd

stats_split[[1, "sd"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "sd_casi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

stats_split[[2, "sd"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "sd_capi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# iqr

stats_split[[1, "iqr"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "iqr_casi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

stats_split[[2, "iqr"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "iqr_capi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# skew

stats_split[[1, "skew"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "skew_casi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

stats_split[[2, "skew"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "skew_capi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# kurtosis

stats_split[[1, "kurtosis"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "kurtosis_casi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

stats_split[[2, "kurtosis"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "kurtosis_capi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# 1st quartile

stats_split[[1, "quantilest"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "quartile_first_casi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

stats_split[[2, "quantilest"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "quartile_first_capi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

# 3rd quartile

stats_split[[1, "quantilerd"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "quartile_third_casi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)

stats_split[[2, "quantilerd"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "quartile_third_capi.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)
```

```{r sd test}
psych::describeBy(allbus2006$immigration, allbus2006$split)

car::leveneTest(allbus2006$immigration, allbus2006$split)
sdtest <- car::leveneTest(allbus2006$immigration, allbus2006$split)

sdtest[[1, "Df"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "sdtest_no.txt"),
              sep = "", col.names = FALSE, row.names = FALSE)

sdtest[[2, "Df"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "sdtest_df.txt"),
              sep = "", col.names = FALSE, row.names = FALSE)

sdtest[[1, "F value"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "sdtest_f.txt"),
              sep = "", col.names = FALSE, row.names = FALSE)

sdtest[[1, "Pr(>F)"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "sdtest_p.txt"),
              sep = "", col.names = FALSE, row.names = FALSE)
```

```{r t test}
ttest <- t.test(allbus2006$immigration ~ allbus2006$split, var.equal = TRUE, alternative = "greater")

ttest

# p wert 

ttest[["p.value"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "ttest_p.txt"),
              sep = "", col.names = FALSE, row.names = FALSE)

# df

ttest[["parameter"]][["df"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "ttest_df.txt"),
              sep = "", col.names = FALSE, row.names = FALSE)

# t 

ttest[["statistic"]][["t"]] |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "ttest_t.txt"),
              sep = "", col.names = FALSE, row.names = FALSE)
```

```{r cohens d}
cohensD(allbus2006$immigration ~ allbus2006$split)

cohensD(allbus2006$immigration ~ allbus2006$split) |> 
  round(digits = 3) |> 
  write.table(file = here::here("stats", "cohensd.txt"), 
              sep = "", col.names = FALSE, row.names = FALSE)
```



```{r boxplot}
ggplot(data = allbus2006, mapping = aes(x = split, y = immigration)) +
  geom_boxplot() +
  scale_y_continuous(
    breaks = c(1:7),
    minor_breaks = seq(0.5, 6.5, 0.5),
    labels = c("negativ", 2:6, "positiv")) +
  labs(
    title = "Einstellung gegenüber Immigration nach Befragungsmodus",
    subtitle = "N = 2635",
    y = "Einstellungen gegenüber Immigration",
    caption = "Daten: ALLBUS 2006"
  ) +
  theme(axis.title.y = element_blank()) +
  coord_flip()

ggplot2::ggsave(here::here("plots", "boxplot.pdf"), dpi = dpi, width = 7, height = 3.5, units = "in")
```


```{r violin plot}
ggplot(data = allbus2006, mapping = aes(x = split, y = immigration)) +
  geom_violin() +
  scale_y_continuous(
    breaks = c(1:7),
    minor_breaks = seq(0.5, 6.5, 0.5),
    labels = c("negativ", 2:6, "positiv")) +
  labs(
    title = "Einstellung gegenüber Immigration nach Befragungsmodus",
    subtitle = "N = 2635",
    y = "Einstellungen gegenüber Immigration",
    caption = "Quelle: ALLBUS 2006"
  ) +
  theme(axis.title.y = element_blank()) +
  coord_flip() +
  geom_boxplot(width = 0.15) 

ggplot2::ggsave(here::here("plots", "violin.pdf"), dpi = dpi)

```

```{r density plot}

ggplot(data = allbus2006, mapping = aes(x = immigration, colour = split)) +
  geom_density(linewidth = 1) +
  scale_color_manual(values = c(colours_colourblind[[7]],
                                colours_colourblind[[6]])) +
  scale_x_continuous(breaks = c(1:7),
                     labels = c("negativ", 2:6, "positiv")) +
  scale_y_continuous(limits = c(0, 0.3)) +
  labs(
    title = "Einstellung gegenüber Immigration nach Befragungsmodus",
    subtitle = "N = 2635",
    x = "Einstellung gegenüber Immigration",
    color = "Befragungsmodus",
    y = "Dichte",
    caption = "Daten: ALLBUS 2006"
  ) +
  theme(legend.position = "bottom") 

ggplot2::ggsave(here::here("plots", "density.pdf"), dpi = dpi, units = "in", width = 7, height = 5)

```

```{r scatter mit ki}
summary_allbus <-
  allbus2006 %>%
  group_by(split) %>%
  do(tidy(lm_robust(immigration ~ 1, data = .))) %>%
  mutate(Y = estimate)


ggplot(data = summary_allbus, aes(x = split, y = Y)) +
  geom_point(
    data = allbus2006,
    aes(split, immigration),
    position = position_jitter(width = 0.2, height = 0.1),
    alpha = 0.15
  ) +
  geom_point(size = 1) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0, linewidth = 1) +
  theme_bw() +
  scale_y_continuous(
    breaks = c(1:7),
    minor_breaks = seq(0.5, 6.5, 0.5),
    labels = c("negativ", 2:6, "positiv")) +
  theme(axis.title.x = element_blank()) +
  labs(
    title = "Einstellung gegenüber Immigration nach Befragungsmodus",
    subtitle = "N = 2635",
    y = "Einstellung gegenüber Immigration",
    caption = "Daten: ALLBUS 2006"
  )

ggplot2::ggsave(here::here("plots", "scatter_ci.pdf"), dpi = dpi)

```


```{r scatter}
ggplot(data = allbus2006, mapping = aes(x = as.numeric(split), y = immigration)) +
  geom_point(alpha = 0.1, position = position_jitter(height = 0.05)) +
  #geom_smooth(method = 'lm', size = 2, color = colours_colourblind[[6]]) +
  scale_y_continuous(
    breaks = c(1:7),
    minor_breaks = seq(0.5, 6.5, 0.5),
    labels = c("negativ - 1", 2:6, "positiv - 7")) +
  scale_x_continuous(breaks = c(1, 2),
                     minor_breaks = NULL,
                     labels = c("CASI", "CAPI")) +
  labs(
    title = "Einstellung gegenüber Immigration nach Befragungsmodus",
    subtitle = "N = 2635",
    y = "Einstellungen gegenüber Immigration",
    caption = "Daten: ALLBUS 2006"
  ) +
  theme(axis.title.x = element_blank()) +
  stat_summary(fun = mean, geom = "point",
                 width = 5) 

ggplot2::ggsave(here::here("plots", "scatter.pdf"), dpi = dpi)
```


# Lineare Regression




## Einfache lineare Regression

```{r m1}
m1.lm <- lm(immigration ~ split, data = allbus2006)
summary(m1.lm) # casi
```

## Multiple lineare Regression

```{r m2}
m2.lm <- lm(immigration ~ split + age_cen + age_cen * split + edu + edu * split + sex + sex * split, data = allbus2006)

summary(m2.lm)
```

```{r m3}
m3.lm <- lm(immigration ~ split + age_cen + age_cen * split + edu + edu * split + sex + sex * split + int_sex + int_sex * split + int_agediff + int_agediff * split + int_exp + int_exp * split + int_edu + int_edu * split, data = allbus2006)

summary(m3.lm)
```

```{r m4}
m4.lm <- lm(immigration ~ split + age_cen + age_cen * split + edu + edu * split + sex + sex * split + int_sex + int_sex * split + int_agediff + int_agediff * split + int_exp + int_exp * split + int_edu + int_edu * split + sdtendency + sdperception, data = allbus2006)

summary(m4.lm)
```

`r modelsummary::modelsummary(list(m1.lm, m2.lm, m3.lm, m4.lm),  stars = T, output = "markdown", statistic = 'p.value')`

```{r modelsummary}
modelsummary::modelsummary(list(m1.lm, m2.lm, m3.lm, m4.lm),  stars = T, statistic = "p.value", output = here::here("tables", "regression.csv"))

modelsummary::modelsummary(list(m1.lm, m2.lm, m3.lm, m4.lm),  stars = T, output = "markdown", statistic = 'p.value')

# modelsummary::modelsummary(list(m1.lm, m2.lm, m3.lm, m4.lm),  
#                            stars = T, 
#                            output = "markdown", 
#                            statistic = c("conf.int",
#               "s.e. = {std.error}", 
#                            "t = {statistic}",
#                            "p = {p.value}"))


```

```{r coefplot}
modelsummary::modelplot(list(m1.lm, m2.lm, m3.lm, m4.lm),
                        background = list(geom_vline(xintercept = 0, color = "darkgrey"))) + 
  aes(color = estimate) +
  scale_color_manual(values = c(colours_colourblind[[1]], colours_colourblind[[2]], colours_colourblind[[4]], colours_colourblind[[7]])) +
  ggtitle("Koeffizientenplot zu Einstellungen gegenüber Immigration") +
  labs(
    colour = "Modell",
    caption = "Daten: ALLBUS 2006",
    subtitle = "Vergleich zwischen CAPI und CASI"
  )

ggplot2::ggsave(here::here("plots", "coefplot.pdf"), dpi = dpi, width = 7, height = 6)

```

## Inverse Interaktion


### Interviewereffekte

#### Geschlecht

```{r}
df <- allbus2006

df %>% 
  ggplot(aes(x = split, y = immigration, col = as.numeric(int_sex))) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = int_sex, group = int_sex)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

#### Interviewer*in Altersdifferenz

```{r}
df <- allbus2006 %>%
  mutate(
    below_median = ifelse(int_agediff < median(int_agediff), "Below Median int_agediff", "Above Median int_agediff"),
    quantile_group = cut(
      include.lowest = TRUE,
      int_agediff, 
      breaks = quantile(int_agediff, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

df %>% 
  ggplot(aes(x = split, y = immigration, col = int_agediff)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

#### Bildung

```{r}
df %>% 
  ggplot(aes(x = split, y = immigration, col = as.numeric(int_edu))) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = int_edu, group = int_edu)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

#### Erfahrung

```{r}
df <- allbus2006 %>%
  mutate(
    below_median = ifelse(int_exp < median(int_exp), "Below Median int_exp", "Above Median int_exp"),
    quantile_group = cut(
      include.lowest = TRUE,
      int_exp, 
      breaks = quantile(int_exp, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

df %>% 
  ggplot(aes(x = split, y = immigration, col = int_exp)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

### Personeneffekte

#### Alter

```{r}
df <- allbus2006 %>%
  mutate(
    below_median = ifelse(age < median(age), "Below Median Age", "Above Median Age"),
    quantile_group = cut(
      age, 
      breaks = quantile(age, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

df %>% 
  ggplot(aes(x = split, y = immigration, col = age)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

#### Geschlecht

```{r}
df %>% 
  ggplot(aes(x = split, y = immigration, col = as.numeric(sex))) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = sex, group = sex)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

#### Bildung

```{r}
df %>% 
  ggplot(aes(x = split, y = immigration, col = as.numeric(edu))) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = edu, group = edu)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```


### SD Wahrnehmung

```{r}
df <- allbus2006 %>%
  mutate(
    below_median = ifelse(sdperception < median(sdperception), "Below Median Age", "Above Median Age"),
    quantile_group = cut(
      sdperception, 
      breaks = quantile(sdperception, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

df %>% 
  ggplot(aes(x = split, y = immigration, col = sdperception)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()
```

### SD-Neigung

```{r}
df <- allbus2006 %>%
  mutate(
    below_median = ifelse(sdtendency < median(sdtendency), "Below Median Age", "Above Median Age"),
    quantile_group = cut(
      sdperception, 
      breaks = quantile(sdtendency, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

df %>% 
  ggplot(aes(x = split, y = immigration, col = sdtendency)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

df %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = df, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()
```



## Robustheitsanalyse

### Regression


```{r nohilfe subset}
allbus2006_robust <- allbus2006 |> 
  filter(split_erfolg == "ja, ohne Hilfe" | split_erfolg == "CAPI")
```

```{r m1_nohilfe}
m1_nohilfe.lm <- lm(immigration ~ split, data = allbus2006_robust)

summary(m1_nohilfe.lm)
```

```{r m2_nohilfe}
m2_nohilfe.lm <- lm(immigration ~ split + age_cen + age_cen * split + edu + edu * split + sex + sex * split, data = allbus2006_robust)

summary(m2_nohilfe.lm)
```

```{r m3_nohilfe}
m3_nohilfe.lm <- lm(immigration ~ split + age_cen + age_cen * split + edu + edu * split + sex + sex * split + int_sex + int_sex * split + int_agediff + int_agediff * split + int_exp + int_exp * split + int_edu + int_edu * split, data = allbus2006_robust)

summary(m3_nohilfe.lm)
```

```{r m4_nohilfe}
m4_nohilfe.lm <- lm(immigration ~ split + age_cen + age_cen * split + edu + edu * split + sex + sex * split + int_sex + int_sex * split + int_agediff + int_agediff * split + int_exp + int_exp * split + int_edu + int_edu * split + sdtendency + sdperception, data = allbus2006_robust)

summary(m4_nohilfe.lm)
```

` r modelsummary::modelsummary(list(m1_nohilfe.lm, m2_nohilfe.lm, m3_nohilfe.lm, m4_nohilfe.lm), stars = T, statistic = "p.value", output = "markdown)`

```{r modelsummary_nohilfe}
modelsummary::modelsummary(list(m1_nohilfe.lm, m2_nohilfe.lm, m3_nohilfe.lm, m4_nohilfe.lm), stars = T, statistic = "p.value")

modelsummary::modelsummary(list(m1_nohilfe.lm, m2_nohilfe.lm, m3_nohilfe.lm, m4_nohilfe.lm),stars = T, output = "markdown", statistic = 'p.value')

```

```{r coefplot robust}
modelsummary::modelplot(list(m1_nohilfe.lm, m2_nohilfe.lm, m3_nohilfe.lm, m4_nohilfe.lm),
                        background = list(geom_vline(xintercept = 0, color = "darkgrey"))) + 
  aes(color = estimate) +
  scale_color_manual(values = c(colours_colourblind[[1]], colours_colourblind[[2]], colours_colourblind[[4]], colours_colourblind[[7]])) +
  ggtitle("Koeffizientenplot zu Einstellungen gegenüber Immigration") +
  labs(
    colour = "Modell",
    caption = "Daten: ALLBUS 2006",
    subtitle = "Vergleich zwischen CAPI und erfolgreichem CASI"
  )

ggplot2::ggsave(here::here("plots", "coefplot_robust.pdf"), dpi = dpi, height = 6, width = 7)
```

### Inverse Interaktion

#### Interviewereffekte

##### Geschlecht

```{r}
allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = as.numeric(int_sex))) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = int_sex, group = int_sex, linetype = int_sex)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    color = colours_colourblind["blindblue"],
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  scale_color_manual(values = c(colours_colourblind[[4]], colours_colourblind[[2]])) +
  scale_linetype_manual(values = c("dashed", "dotdash")) 


ggplot2::ggsave(here::here("plots", "robust_int_sex.pdf"), dpi = dpi, width = 7, height = 3.5, units = "in")
```

##### Interviewer*in Altersdifferenz

```{r}
allbus2006_robust <- allbus2006_robust %>%
  mutate(
    below_median = ifelse(int_agediff < median(int_agediff), "Below Median int_agediff", "Above Median int_agediff"),
    quantile_group = cut(
      include.lowest = TRUE,
      int_agediff, 
      breaks = quantile(int_agediff, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = int_agediff)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

##### Bildung

```{r}
allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = as.numeric(int_edu))) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = int_edu, group = int_edu)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

##### Erfahrung

```{r}
allbus2006_robust <- allbus2006_robust %>%
  mutate(
    below_median = ifelse(int_exp < median(int_exp), "Unter Median int_exp", "Über Median int_exp"),
    Quartile = cut(
      int_exp, 
      breaks = quantile(int_exp, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      include.lowest = TRUE,
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = int_exp)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = Quartile, group = Quartile, linetype = Quartile)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    color = colours_colourblind["blindblue"],
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  scale_color_manual(values = c(colours_colourblind[[2]], colours_colourblind[[3]], colours_colourblind[[4]], colours_colourblind[[7]])) +
  scale_linetype_manual(values = c("dashed", "dotdash", "twodash", "dotted")) +
  labs(
    title = "Der Effekt des Befragungsmodus auf geäußerte Einstellungen 
    gegenüber Immigration nach Quartilen der Interviewendenerfahrung",
    subtitle = "Haupteffekt in Dunkelblau",
    caption = "Daten: ALLBUS 2006",
    y = "Einstellungen gegenüber Immigration"
    )  +
  theme(axis.title.x = element_blank())

ggplot2::ggsave(here::here("plots", "robust_int_exp_quartile.pdf"), dpi = dpi, width = 7, height = 3.5, units = "in")


allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, 
             col = below_median, group = below_median, linetype = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    color = colours_colourblind["blindblue"],
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(
    title = "Der Effekt des Befragungsmodus auf geäußerte Einstellungen 
    gegenüber Immigration nach Quantilen der Interviewendenerfahrung",
    subtitle = "Haupteffekt in Dunkelblau",
    caption = "Daten: ALLBUS 2006",
    y = "Einstellungen gegenüber Immigration"
    ) +
  scale_color_manual(values = c(colours_colourblind[[4]], colours_colourblind[[2]])) +
  scale_linetype_manual(values = c("dashed", "dotdash")) +
  theme(axis.title.x = element_blank())

ggplot2::ggsave(here::here("plots", "robust_int_exp_med.pdf"), dpi = dpi, width = 7, height = 3.5, units = "in")

quantile(allbus2006$int_exp)
```

#### Personeneffekte

##### Alter

```{r}
allbus2006_robust <- allbus2006_robust %>%
  mutate(
    below_median = ifelse(age < median(age), "Below Median Age", "Above Median Age"),
    quantile_group = cut(
      include.lowest = TRUE,
      age, 
      breaks = quantile(age, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = age)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

##### Geschlecht

```{r}
allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = as.numeric(sex))) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = sex, group = sex)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

##### Bildung

```{r}
allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = as.numeric(edu))) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = edu, group = edu)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()

```

##### SD Wahrnehmung

```{r}
allbus2006_robust <- allbus2006_robust %>%
  mutate(
    below_median = ifelse(sdperception < median(sdperception), "Below Median Age", "Above Median Age"),
    quantile_group = cut(
      sdperception, 
      breaks = quantile(sdperception, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = sdperception)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()
```

##### SD-Neigung

```{r}
allbus2006_robust <- allbus2006_robust %>%
  mutate(
    below_median = ifelse(sdtendency < median(sdtendency), "Below Median Age", "Above Median Age"),
    quantile_group = cut(
      sdperception, 
      breaks = quantile(sdtendency, probs = c(0, 0.25, 0.5, 0.75, 1)), 
      labels = c("Q1", "Q2", "Q3", "Q4")
    )
  )

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = sdtendency)) +
  geom_jitter() +
  scale_color_viridis_c() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = quantile_group, group = quantile_group)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  theme_classic()

allbus2006_robust %>% 
  ggplot(aes(x = split, y = immigration, col = below_median, group = below_median)) +
  # geom_jitter() +
  geom_smooth(method = "glm", se = FALSE) +
  geom_smooth(
    method = "glm", se = FALSE,
    data = allbus2006_robust, aes(x = split, y = immigration, group = NA), inherit.aes = FALSE
  ) +
  labs(subtitle = "Main effect in blue") +
  theme_classic()
```

### Gruppenunterschiede

```{r}
allbus2006_robust  |> 
  select(age, split) |> 
  tbl_summary(by = split)  |> 
  add_p()

allbus2006_robust  |> 
  select(edu, split) |> 
  tbl_summary(by = split)  |> 
  add_p() 
```



## Regressionsdiagnostik

```{r diagnostic}
pdf(here::here("plots", "diagnostics.pdf"), width = 7, height = 7)
par(mfrow = c(2, 2))
plot(m4.lm, col = rgb(0, 0, 0, alpha = 0.3))
dev.off()

# Für Robustheitsanalyse

pdf(here::here("plots", "diagnostics_robust.pdf"), width = 7, height = 7)
par(mfrow = c(2, 2))
plot(m4_nohilfe.lm, col = rgb(0, 0, 0, alpha = 0.3))
dev.off()
```


### Normalverteilung Zielvariable

```{r Normalverteilung immigration}
skewness(allbus2006$immigration)

skewness(allbus2006$immigration) |> 
  round(digits = 3) |> 
  write.table(here::here("stats", "skew_immigration.txt"),
              col.names = FALSE, row.names = FALSE)

kurtosis(allbus2006$immigration)

kurtosis(allbus2006$immigration) |> 
  round(digits = 3) |> 
  write.table(here::here("stats", "kurtosis_immigration.txt"),
              col.names = FALSE, row.names = FALSE)

allbus2006 |> 
  ggplot(aes(x = immigration)) +
  geom_histogram(bins = 13, colour = "gray40", fill = "gray70") +
  labs(
    title = "Histogramm der Einstellungen gegenüber Immigration",
    subtitle = "N = 2635",
    x = "Einstellungen gegenüber Immigration",
    y = "Anzahl",
    caption = "Daten: ALLBUS 2006"
  ) +
  scale_y_continuous(limits = c(0, 400)) +
  scale_x_continuous(
    breaks = c(1:7),
    minor_breaks = seq(0.5, 6.5, 0.5),
    labels = c("negativ", 2:6, "positiv")
  )

ggsave(here::here("plots", "histogram.pdf"), dpi = dpi)
```


```{r Normalverteilung immigration robust}
skewness(allbus2006_robust$immigration)

skewness(allbus2006_robust$immigration) |> 
  round(digits = 3) |> 
  write.table(here::here("stats", "skew_immigration_robust.txt"),
              col.names = FALSE, row.names = FALSE)

kurtosis(allbus2006_robust$immigration)

kurtosis(allbus2006_robust$immigration) |> 
  round(digits = 3) |> 
  write.table(here::here("stats", "kurtosis_immigration_robust.txt"),
              col.names = FALSE, row.names = FALSE)

allbus2006_robust |> 
  ggplot(aes(x = immigration)) +
  geom_histogram(bins = 13, colour = "gray40", fill = "gray70") +
  labs(
    title = "Histogramm der Einstellungen gegenüber Immigration 
    für CAPI-Befragte und erfolgreiche CASI-Befragte",
    subtitle = "N = 2104",
    x = "Einstellungen gegenüber Immigration",
    y = "Anzahl",
    caption = "Daten: ALLBUS 2006"
  ) +
  scale_y_continuous(limits = c(0, 350)) +
  scale_x_continuous(
    breaks = c(1:7),
    minor_breaks = seq(0.5, 6.5, 0.5),
    labels = c("negativ", 2:6, "positiv")
  )

ggsave(here::here("plots", "histogram_robust.pdf"), dpi = dpi)
```

### Linearität

```{r linearitat}
plot(m4.lm, 1, col = rgb(0, 0, 0, alpha = 0.5))

png(here::here("plots", "diag_linear.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4.lm, 1, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

#Rainbow-Test (mit lmtest-Package) auf Linearität
# (signifikant => Verletzung der Linearität)
lmtest::raintest(m4.lm)

# Für Robustheitsanalyse

plot(m4_nohilfe.lm, 1, col = rgb(0, 0, 0, alpha = 0.5))

png(here::here("plots", "diag_linear_robust.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4.lm, 1, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()
```


### Normalverteilung der Residuen

```{r norm}
# (Histogramm sollte möglichst nahe an der 
# Normalverteilung liegen,
# vor allem an den beiden Außenrändern der Verteilung)
olsrr::ols_plot_resid_hist(m4.lm)

# QQ Plot
plot(m4.lm, 2, col = rgb(0, 0, 0, alpha = 0.5))

png(here::here("plots", "diag_norm.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4.lm, 2, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()


# Shapiro-Wilk-Test auf Normalverteilung
# (signifikant => Residuen nicht normalverteilt)
shapiro.test(m4.lm$residuals)

# Schiefe und Kurtosis (mit moments-Package)
#(Bei Normalverteilung skewness nahe 0 und kurtosis nahe 3)
moments::skewness(m4.lm$residuals)
moments::skewness(m4.lm$residuals) |> 
  round(digits = 3) |> 
  write.table(here::here("stats", "residual_skew.txt"),
              col.names = FALSE, row.names = FALSE)

moments::kurtosis(m4.lm$residuals)
moments::kurtosis(m4.lm$residuals) |> 
  round(digits = 3) |> 
  write.table(here::here("stats", "residual_kurtosis.txt"),
              col.names = FALSE, row.names = FALSE)

# Signifikanztests für Schiefe und Kurtosis 
#(mit moments-Package)
#(signifikant = Residuen nicht normalverteilt)
moments::agostino.test(m4.lm$residuals)
moments::anscombe.test(m4.lm$residuals)

### Für Robustheitsanalyse

# (Histogramm sollte möglichst nahe an der 
# Normalverteilung liegen,
# vor allem an den beiden Außenrändern der Verteilung)
olsrr::ols_plot_resid_hist(m4_nohilfe.lm)

# QQ Plot
plot(m4_nohilfe.lm, 2, col = rgb(0, 0, 0, alpha = 0.5))

png(here::here("plots", "diag_norm_robust.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4_nohilfe.lm, 2, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()


# Shapiro-Wilk-Test auf Normalverteilung
# (signifikant => Residuen nicht normalverteilt)
shapiro.test(m4_nohilfe.lm$residuals)

# Schiefe und Kurtosis (mit moments-Package)
#(Bei Normalverteilung skewness nahe 0 und kurtosis nahe 3)
moments::skewness(m4_nohilfe.lm$residuals)
moments::skewness(m4_nohilfe.lm$residuals) |> 
  round(digits = 3) |> 
  write.table(here::here("stats", "residual_skew_robust.txt"),
              col.names = FALSE, row.names = FALSE)

moments::kurtosis(m4_nohilfe.lm$residuals)
moments::kurtosis(m4_nohilfe.lm$residuals) |> 
  round(digits = 3) |> 
  write.table(here::here("stats", "residual_kurtosis_robust.txt"),
              col.names = FALSE, row.names = FALSE)

# Signifikanztests für Schiefe und Kurtosis 
#(mit moments-Package)
#(signifikant = Residuen nicht normalverteilt)
moments::agostino.test(m4_nohilfe.lm$residuals)
moments::anscombe.test(m4_nohilfe.lm$residuals)
```


### Homoskedaszität

```{r}
plot(m4.lm, 3, col = rgb(0, 0, 0, alpha = 0.5))

# graphisch
png(here::here("plots", "diag_location.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4.lm, 3, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

# Breusch Pagan Test - Signifikanztest auf Heteroskedastizität
# (signifikant => Heteroskedastizität)
olsrr::ols_test_breusch_pagan(m4.lm)

plot(m4.lm, 3, col = rgb(0, 0, 0, alpha = 0.5))

# graphisch
png(here::here("plots", "diag_location.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4.lm, 3, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

# Breusch Pagan Test - Signifikanztest auf Heteroskedastizität
# (signifikant => Heteroskedastizität)
olsrr::ols_test_breusch_pagan(m4.lm)

### Für Robustheitsanalyse

plot(m4_nohilfe.lm, 3, col = rgb(0, 0, 0, alpha = 0.5))

# graphisch
png(here::here("plots", "diag_location_robust.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4_nohilfe.lm, 3, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

# Breusch Pagan Test - Signifikanztest auf Heteroskedastizität
# (signifikant => Heteroskedastizität)
olsrr::ols_test_breusch_pagan(m4_nohilfe.lm)

plot(m4_nohilfe.lm, 3, col = rgb(0, 0, 0, alpha = 0.5))

# graphisch
png(here::here("plots", "diag_location_robust.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4_nohilfe.lm, 3, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

# Breusch Pagan Test - Signifikanztest auf Heteroskedastizität
# (signifikant => Heteroskedastizität)
olsrr::ols_test_breusch_pagan(m4_nohilfe.lm)
```

### Einflussreiche Werte

```{r}
plot(m4.lm, 4, col = rgb(0, 0, 0, alpha = 0.5))


png(here::here("plots", "diag_student.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4.lm, 4, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

plot(m4.lm, 5, col = rgb(0, 0, 0, alpha = 0.5))


png(here::here("plots", "diag_leverage.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4.lm, 5, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

#  Studentisierte Residuen
# (problematisch: Werte absolut über 3 )
olsrr::ols_plot_resid_stud(m4.lm)

# DiffBeta
# (Welche Beobachtungen haben einen großen Einfluss auf die
# Parameterschätzung?)
olsrr::ols_plot_dfbetas(m4.lm)

### Für Robustheitsanalyse

plot(m4_nohilfe.lm, 4, col = rgb(0, 0, 0, alpha = 0.5))


png(here::here("plots", "diag_student_robust.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4_nohilfe.lm, 4, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

plot(m4_nohilfe.lm, 5, col = rgb(0, 0, 0, alpha = 0.5))


png(here::here("plots", "diag_leverage_robust.png"), res = 200, units = "in", width = 7, height = 5)
plot(m4_nohilfe.lm, 5, col = rgb(0, 0, 0, alpha = 0.5))
dev.off()

#  Studentisierte Residuen
# (problematisch: Werte absolut über 3 )
olsrr::ols_plot_resid_stud(m4_nohilfe.lm)

# DiffBeta
# (Welche Beobachtungen haben einen großen Einfluss auf die
# Parameterschätzung?)
olsrr::ols_plot_dfbetas(m4_nohilfe.lm)
```

### Keine Multikollinearität

```{r}
vif(m4.lm)

# abwesenheit von starker Multikollinearität

# (Problematisch: VIF-Werte über 10.0)
olsrr::ols_vif_tol(m4.lm)

### für Robustheitsanalyse

vif(m4_nohilfe.lm)

olsrr::ols_vif_tol(m4_nohilfe.lm)
```

## Simulation

```{r simulation}
pt_H0 <- replicate(n = 1000, expr = {
  sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  ttestH0 <- t.test(sub_allbus2006$immigration ~ sub_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH0$p.value
})

hist(pt_H0, breaks = 20) 

mean(pt_H0 < 0.05)

tt_H0 <- replicate(n = 10000, expr = {
  sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  ttestH0 <- t.test(sub_allbus2006$immigration ~ sub_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH0$statistic
})

hist(tt_H0, breaks = 50, freq = FALSE) # freq = FALSE, damit relative Häufigkeiten eingetragen werden!
x <- seq(-4, 4, 0.01) # Sequenz von -4 bis 4 in 0.01 Schritten
lines(x = x, y = dt(x = x, df = 38), lwd = 2) # lwd = Liniendicke

t_krit <- qt(p = .975, df = 38)
mean(abs(tt_H0) > t_krit) # empirischer Alpha-Fehler
```

## Poweranalyse

```{r poweranalyse}
sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  alter_allbus2006 <- sub_allbus2006 |> 
    mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.5,
                                   TRUE ~ immigration))
  
ttestH1 <- t.test(alter_allbus2006$immigration ~ alter_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH1$p.value


pt_H1 <- replicate(n = 1000, expr = {
  sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  alter_allbus2006 <- sub_allbus2006 |> 
    mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.5,
                                   TRUE ~ immigration))
  ttestH1 <- t.test(alter_allbus2006$immigration ~ alter_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH1$p.value
})

mean(pt_H1 < 0.05)

hist(pt_H1, breaks = 20)

tt_H1 <- replicate(n = 1000, expr = {
  sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  alter_allbus2006 <- sub_allbus2006 |> 
    mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.5,
                                   TRUE ~ immigration))
  ttestH1 <- t.test(alter_allbus2006$immigration ~ alter_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH1$statistic
})

hist(tt_H1, breaks = 50, freq = FALSE) # freq = FALSE, damit relative Häufigkeiten eingetragen werden!
x <- seq(-4, 4, 0.01) # Sequenz von -4 bis 4 in 0.01 Schritten
lines(x = x, y = dt(x = x, df = 38), lwd = 2) # lwd = Liniendicke
```


```{r powerplot}
pt_H1_500 <- pt_H1
pt_H1_400 <- replicate(n = 1000, expr = {
  sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  alter_allbus2006 <- allbus2006 |> 
    mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.5,
                                   TRUE ~ immigration))
  ttestH1 <- t.test(alter_allbus2006$immigration ~ alter_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH1$p.value
})
pt_H1_300 <- replicate(n = 1000, expr = {
  sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  alter_allbus2006 <- sub_allbus2006 |> 
    mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.5,
                                   TRUE ~ immigration))
  ttestH1 <- t.test(alter_allbus2006$immigration ~ alter_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH1$p.value
})
pt_H1_200 <- replicate(n = 1000, expr = {
  sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  alter_allbus2006 <- sub_allbus2006 |> 
    mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.5,
                                   TRUE ~ immigration))
  ttestH1 <- t.test(alter_allbus2006$immigration ~ alter_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH1$p.value
})
pt_H1_100 <- replicate(n = 1000, expr = {
  sub_allbus2006 <- allbus2006[sample(nrow(allbus2006), size = 500), ]
  alter_allbus2006 <- sub_allbus2006 |> 
    mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.5,
                                   TRUE ~ immigration))
  ttestH1 <- t.test(alter_allbus2006$immigration ~ alter_allbus2006$split, var.equal = TRUE, alternative = "greater")
  ttestH1$p.value
})

t_power <- c(mean(pt_H1_100 < 0.05),
             mean(pt_H1_200 < 0.05),
             mean(pt_H1_300 < 0.05),
             mean(pt_H1_400 < 0.05),
             mean(pt_H1_500 < 0.05))
t_power

Ns <- seq(100, 500, 100)
plot(x = Ns, y = t_power, type = "b", main = "Power vs. N")
```


## Sensitivitätsanalyse

```{r sensitivity}
pt_H1_00 <- sens_allbus <- allbus2006 |> 
  mutate(immigration = case_when(split == "CAPI" ~ immigration + 0,
                                 TRUE ~ immigration))
ttestH1_00 <- t.test(pt_H1_00$immigration ~ pt_H1_00$split, var.equal = TRUE, alternative = "greater")
ttestH1_00p <-  ttestH1_00$p.value

pt_H1_05 <- sens_allbus <- allbus2006 |> 
  mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.05,
                                 TRUE ~ immigration))
ttestH1_05 <- t.test(pt_H1_05$immigration ~ pt_H1_05$split, var.equal = TRUE, alternative = "greater")
ttestH1_05p <-   ttestH1_05$p.value

pt_H1_10 <- sens_allbus <- allbus2006 |> 
  mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.1,
                                 TRUE ~ immigration))
ttestH1_10 <- t.test(pt_H1_10$immigration ~ pt_H1_10$split, var.equal = TRUE, alternative = "greater")
ttestH1_10p <-   ttestH1_10$p.value

pt_H1_15 <- sens_allbus <- allbus2006 |> 
  mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.15,
                                 TRUE ~ immigration))
ttestH1_15 <- t.test(pt_H1_15$immigration ~ pt_H1_15$split, var.equal = TRUE, alternative = "greater")
ttestH1_15p <-   ttestH1_15$p.value

pt_H1_20 <- sens_allbus <- allbus2006 |> 
  mutate(immigration = case_when(split == "CAPI" ~ immigration + 0.2,
                                 TRUE ~ immigration))
ttestH1_20 <- t.test(pt_H1_20$immigration ~ pt_H1_20$split, var.equal = TRUE, alternative = "greater")
ttestH1_20p <-  ttestH1_20$p.value

t_sens <- c(ttestH1_00p,
            ttestH1_05p,
            ttestH1_10p,
            ttestH1_15p,
            ttestH1_20p)

Es <- seq(0, 0.2, 0.05)
plot(x = Es, y = t_sens, type = "b", main = "Sensitivity vs. Effektgröße")
```






